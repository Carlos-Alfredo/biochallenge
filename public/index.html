<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Chat LLM</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 720px; margin: 24px auto; }
    #messages { border:1px solid #ddd; min-height: 300px; padding:12px; border-radius:8px; }
    .msg{ margin:10px 0 } .user{text-align:right} .model{text-align:left}
    .role{font-size:12px;color:#666}
  </style>
</head>
<body>
  <h1>Chat (Firebase + Vertex AI)</h1>
  <div id="messages"></div>
  <form id="f" style="margin-top:12px;">
    <input id="q" placeholder="Escreva sua pergunta..." style="width:78%"/>
    <button>Enviar</button>
  </form>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    let uid=null, chatId="default";
    const msgs=[], box=document.getElementById('messages'), input=document.getElementById('q');
    const form=document.getElementById('f');
    const render=()=>{ box.innerHTML = msgs.map(m=>`
      <div class="msg ${m.role}">
        <div class="role">${m.role}</div><div>${m.content}</div>
      </div>`).join(""); box.scrollTop=box.scrollHeight; };

    onAuthStateChanged(auth, async (u)=>{ if(!u) await signInAnonymously(auth); else uid=u.uid; });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text = input.value.trim(); if(!text||!uid) return;
      msgs.push({role:'user', content:text}); render(); input.value='';
      const r = await fetch('/api/chat', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ uid, chatId, messages: msgs })
      });
      const data = await r.json();
      msgs.push({role:'model', content: data.reply || '(sem resposta)'}); render();
    });
  </script>
</body>
</html>
